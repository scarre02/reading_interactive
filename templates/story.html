<!-- story.html -->

{% extends "base.html" %}

{% block title %}{{ story.title }} - Short Stories{% endblock %}

{% block content %}
<!-- It comes from the database -->
<h1>{{ story.title }}</h1>
<img src="{{ url_for('static', filename=story.image) }}" class="small-image">

<div id="story-content">
    {{ story.content | safe }}
</div>

<h2>Keywords:</h2>
<ul id="keyword-list">
    {% for keyword in story.words %}
        <li>{{ keyword }}</li>
    {% endfor %}
</ul>

<h2>Word to Pronounce:</h2>
<p id="current-word" style="visibility: hidden;">Press "Speak" to start</p>

<h2>Word Recognized:</h2>
<p id="recognized-word"></p>

<h2>Progress:</h2>
<p>Correct words pronounced: <span id="correct-count">0</span></p>
<p>Incorrect words pronounced: <span id="incorrect-count">0</span></p>
<ul id="correct-words-list"></ul>

<div class="main-container">
    <!-- Button to start speech recognition -->
    <button id="start-recognition" onclick="startSpeechRecognition()" style="font-size: 18px; padding: 10px 20px; width: 150px; height: 50px;">Speak</button>
</div>

<script>
    let firstWordShown = false;

    function startSpeechRecognition() {
        // Show the first word only if it has not been shown yet.
        if (!firstWordShown) {
            const keywordList = document.querySelectorAll("#keyword-list li");
            if (keywordList.length > 0) {
                document.getElementById("current-word").innerText = keywordList[0].innerText;
                document.getElementById("current-word").style.visibility = "visible";
                firstWordShown = true;
            }
        }

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = "en-US";
        recognition.start();

        recognition.onresult = function (event) {
            let spokenWord = event.results[0][0].transcript.trim().toLowerCase();
            document.getElementById("recognized-word").innerText = `Recognized: ${spokenWord}`;

            let currentWord = document.getElementById("current-word").innerText.toLowerCase();

            if (spokenWord === currentWord) {
                alert(`✅ Correct! You said: ${spokenWord}`);
                
                // Add the word to the list of correct ones.
                let correctWordsList = document.getElementById("correct-words-list");
                let newItem = document.createElement("li");
                newItem.innerText = spokenWord;
                correctWordsList.appendChild(newItem);

                // Increase the correct answer counter.
                let correctCount = document.getElementById("correct-count");
                correctCount.innerText = parseInt(correctCount.innerText) + 1;

                // Get the next word to pronounce.
                let keywordList = Array.from(document.querySelectorAll("#keyword-list li")).map(li => li.innerText.toLowerCase());
                let pronouncedList = Array.from(correctWordsList.children).map(li => li.innerText);
                let remainingWords = keywordList.filter(word => !pronouncedList.includes(word));

                if (remainingWords.length > 0) {
                    document.getElementById("current-word").innerText = remainingWords[0];
                } else {
                    // All words have been pronounced correctly
                    document.getElementById("current-word").innerText = "All words have been pronounced correctly.";
                    
                    // Redirect to the feedback page
                    setTimeout(() => {
                        window.location.href = "/feedback";  
                    }, 1000); // Wait 1 second before redirecting.
                }
            } else {
                alert(`❌ Incorrect! Try again.`);
                // Increase the incorrect answer counter.
                let incorrectCount = document.getElementById("incorrect-count");
                incorrectCount.innerText = parseInt(incorrectCount.innerText) + 1;
            }
        };

        recognition.onerror = function (event) {
            alert("Speech recognition error: " + event.error);
        };
    }
</script>

{% endblock %}
